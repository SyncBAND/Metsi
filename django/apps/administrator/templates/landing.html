
{% load static %}

<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Metsi</title>
        <link href="https://fonts.googleapis.com/css?family=Nunito:300,400,400i,600,700,800,900" rel="stylesheet">
        
        <style>
            @font-face {
                font-family: "iconsmind";
                src: url("{% static 'api_auth/css/iconsmind.eot?ioqkm7' %}");
                src: url("{% static 'api_auth/css/iconsmind.eot?ioqkm7#iefix' %}") format("embedded-opentype"),
                url("{% static 'api_auth/css/iconsmind.ttf?ioqkm7' %}") format("truetype"),
                url("{% static 'api_auth/css/iconsmind.woff?ioqkm7' %}") format("woff"),
                url("{% static 'api_auth/css/iconsmind.svg?ioqkm7#iconsmind' %}") format("svg");
                font-weight: normal;
                font-style: normal;
            }

            @import url("{% static 'api_auth/css/iconsmind.css' %}");
        </style>

        <link href="{% static 'api_auth/css/lite-purple.min.css' %}" rel="stylesheet">
        <link href="{% static 'api_auth/css/toastr.css' %}" rel="stylesheet">
        <script src="{% static 'api_auth/js/knockout-3.5.1.js' %}"></script>
        <script src="{% static 'api_auth/js/jquery-3.5.1.min.js' %}"></script>
        <script src="{% static 'api_auth/js/sammy.min.js' %}" type="text/javascript"></script>
        <script src="{% static 'api_auth/js/toastr.js' %}"></script>
    </head>
    <body>
        <div class="auth-layout-wrap" style="background-image: url({% static 'api_auth/images/billboard.jpg' %})">
            <div class="auth-content">
                <div class="card o-hidden">
                        
                    <div class="row" data-bind="visible: choosenPage() == 'login'">
                        
                        <div class="col-md-6">
                            <div class="p-4">
                                <div class="auth-logo text-center mb-4"><img src="{% static 'api_auth/images/logo.png' %}" alt=""></div>
                                <h1 class="mb-3 text-18">Sign In</h1>
                                <form>
                                    <div class="form-group">
                                        <label for="email">Email address</label>
                                        <input class="form-control form-control-rounded" data-bind="textInput: email" type="email">
                                    </div>
                                    <div class="form-group">
                                        <label for="password">Password</label>
                                        <div class="input-right-icon">
                                            <input class="form-control form-control-rounded" data-bind="textInput: password, attr: { 'type': pass_text}" type="text">
                                            <span class="span-right-input-icon" style="cursor: pointer;" data-bind="click: change_pass_text"><i class="ul-form__icon i-Eye"></i></span>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary btn-block btn-rounded mt-3" data-bind="visible: !loading(), click: login">LOGIN</button>
                                </form>
                                <div class="mt-3 text-center"><a class="text-muted" data-bind="click: goToFolder.bind($data, 'forgot')">
                                        <u>Forgot Password?</u></a></div>
                                <br/>
                                <div><a class="btn btn-rounded btn-outline-primary btn-outline-email btn-block btn-icon-text" data-bind="click: goToFolder.bind($data, 'signin') "><i class="i-Mail-with-At-Sign"></i> Sign up with Email</a></div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 text-center" style="background-size: cover;background-image: url({% static 'api_auth/images/photo-long-3.jpg' %})">
                        </div>
                        
                    </div>
                    <div class="row" data-bind="visible: choosenPage() == 'forgot'">
                        
                        <div class="col-md-6">
                            <div class="p-4">
                                <div class="auth-logo text-center mb-4"><img src="{% static 'api_auth/images/logo.png' %}" alt=""></div>
                                <h1 class="mb-3 text-18">Forgot Password</h1>
                                <form>
                                    <div class="form-group">
                                        <label for="email">Email address</label>
                                        <input class="form-control form-control-rounded" data-bind="textInput: email" type="email">
                                    </div>
                                    <button class="btn btn-primary btn-block btn-rounded mt-3" data-bind="visible: !loading(), click: forgot">Reset Password</button>
                                </form>
                                <div class="mt-3 text-center"><a class="text-muted" data-bind="click: goToFolder.bind($data, 'login')">
                                        <u>Log in</u></a></div>
                            </div>
                        </div>
                        <div class="col-md-6 text-center" style="background-size: cover;background-image: url({% static 'api_auth/images/photo-long-3.jpg' %})">
                        </div>
                        
                    </div>
                    <div class="row" data-bind="visible: choosenPage() == 'signin'" style="background-color: white; border-radius: 15px;">
                        
                        <div class="col-md-6">
                            <div class="p-4">
                                <h1 class="mb-3 text-18">Sign Up</h1>
                                <form>
                                    <div class="form-group">
                                        <label for="username">Your name</label>
                                        <input class="form-control form-control-rounded" data-bind="textInput: first_name" type="text">
                                    </div>
                                    <div class="form-group">
                                        <label for="email">Email address</label>
                                        <input class="form-control form-control-rounded" data-bind="textInput: email" type="email">
                                    </div>
                                    <div class="form-group">
                                        <label for="username">Cell</label>
                                        <input class="form-control form-control-rounded"  data-bind="textInput: cell"type="text">
                                    </div>
                                    <div class="form-group">
                                        <label for="password">Password</label>
                                        <div class="input-right-icon">
                                            <input class="form-control form-control-rounded" data-bind="textInput: password, attr: { 'type': pass_text}" type="text">
                                            <span class="span-right-input-icon" style="cursor: pointer;" data-bind="click: change_pass_text"><i class="ul-form__icon i-Eye"></i></span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="password">Retype password</label>
                                        <div class="input-right-icon">
                                            <input class="form-control form-control-rounded" data-bind="textInput: confirm_password, attr: { 'type': pass_text}" type="text">
                                            <span class="span-right-input-icon" style="cursor: pointer;" data-bind="click: change_pass_text"><i class="ul-form__icon i-Eye"></i></span>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary btn-block btn-rounded mt-3" data-bind="visible: !loading(), click: signup">Sign Up</button>
                                </form>
        
                                <div class="mt-3 text-center"><a class="text-muted" data-bind="click: goToFolder.bind($data, 'login')">
                                    <u>Log In</u></a></div>
                            </div>
                        </div>
        
                        <div class="col-md-6 text-center" style="background-size: cover;background-image: url({% static 'api_auth/images/photo-long-3.jpg' %})">
                        </div>

                    </div>

                </div>
            </div>
        </div>

        <script>
            function LandingViewModel() {

                self = this;

                self.email = ko.observable("");
                self.password = ko.observable("");


                self.first_name = ko.observable("");
                self.cell = ko.observable("");
                self.confirm_password = ko.observable("");

                self.pass_text = ko.observable("password");

                self.loading = ko.observable(false)

                this.change_pass_text = function() {
                    if( self.pass_text() == "password")
                        self.pass_text("text")
                    else
                        self.pass_text("password")
                }
                
                self.choosenPage = ko.observable('');

                self.signup = function(){

                    self.loading(true)

                    let formArray = {
                        'first_name': self.first_name(),
                        'email': self.email(),
                        'cell': self.cell(),
                        'email': self.email(),
                        'password': self.password(),
                        'password2': self.confirm_password(),
                        'group': 'auto'
                    }
            
                    setTimeout(()=>{
                        $.ajax({
                            url: `/api/auth/register-view/`,
                            type: "POST",
                            dataType: "json",
                            data: formArray,
                            async: false,
                            success: function (result) {
                                self.loading(false)
                                console.log(result)
                                self.login()
                            },
                            error: function (response) {
                                self.loading(false)
                                toastr.warning(JSON.stringify(response.responseText), "Sign up error", {
                                    hideDuration: 3000
                                });
                            }
                        })
                    }, 500)
                }

                self.login = function(){

                    let formArray = {'email' : self.email(), 'password': self.password()}

                    self.loading(true)

                    setTimeout(()=>{
                        $.ajax({
                            url: `/api/auth/login-view/`,
                            type: "POST",
                            dataType: "json",
                            data: formArray,
                            async: false,
                            success: function (result) {
                                console.log(result)
                                self.reset_password('login')
                                window.location.reload()
                            },
                            error: function (response) {
                                self.loading(false)
                                toastr.warning(JSON.stringify(response.responseText), "Login error", {
                                    hideDuration: 3000
                                });
                            }
                        })
                    }, 500)
                }

                self.forgot = function(){

                    let formArray = {'email' : self.email()}

                    self.loading(true)

                    setTimeout(()=>{
                        $.ajax({
                            url: `/api/auth/reset-password/`,
                            type: "POST",
                            dataType: "json",
                            data: formArray,
                            async: false,
                            success: function (result) {
                                self.loading(false)
                                self.reset_password('login')
                                toastr.info(JSON.stringify(result.detail), "Done", {
                                    hideDuration: 3000
                                });
                            },
                            error: function (response) {
                                self.loading(false)
                                toastr.warning(JSON.stringify(response.responseText), "Forgot error", {
                                    hideDuration: 3000
                                });
                            }
                        })
                    }, 500)
                }

                // Behaviours    
                self.goToFolder = function(page) { 
                    location.hash = page;
                    self.reset_password(page) 
                };

                self.reset_password = function(page){
                    self.password("")
                    self.confirm_password("")
                    self.choosenPage(page); 
                }

                // Client-side routes    
                Sammy(function() {
                    
                    this.get('#:page', function() {
                        if(this.params.page == 'login' || this.params.page == 'signin' || this.params.page == 'forgot')
                            self.reset_password(this.params.page)
                        else
                            self.reset_password('login')
                    });
                    this.get('', function() {
                        self.reset_password('login')
                    });

                }).run();
            }

            // Activates knockout.js
            ko.applyBindings(new LandingViewModel());

        </script>
    </body>
</html>